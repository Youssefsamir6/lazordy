{% extends 'base.html' %}
{% load i18n %} {# Essential for Django's i18n #}

{% load static %}

{% block content %}
<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
        <h1 id="pageTitle" class="text-3xl font-bold">
            {% trans "Invoice List" %} {# Using trans #}
        </h1>

        {% get_current_language as CURRENT_LANGUAGE %}
        <form action="{% url 'set_language' %}" method="post">
            {% csrf_token %}
            <input name="next" type="hidden" value="{{ request.path }}">
            <input type="hidden" name="language" value="{% if CURRENT_LANGUAGE == 'ar' %}en{% else %}ar{% endif %}">
            <button type="submit" id="langToggle" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition">
                {% if CURRENT_LANGUAGE == 'ar' %}ðŸ‡¬ðŸ‡§ English{% else %}ðŸ‡¸ðŸ‡¦ Arabic{% endif %}
            </button>
        </form>
    </div>

    <div class="mb-4 flex justify-between items-center">
        {# Button to create new invoice in Admin #}
        <a href="{% url 'admin:inventory_invoice_add' %}"
           class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
            {% trans "Create New Invoice" %} {# Using trans #}
        </a>

        <div class="relative">
            <input type="text"
                   id="invoiceSearch"
                   class="border border-gray-300 p-2 rounded-lg pl-10 w-64"
                   placeholder="{% trans 'Search invoices...' %}"> {# Using trans for placeholder #}
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                          d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                          clip-rule="evenodd" />
                </svg>
            </div>
        </div>
    </div>

    {% if invoices %}
    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="invoiceTable">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Invoice Number" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Customer Name" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Invoice Date" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Total Amount" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Amount Paid" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Remaining" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Status" %} {# Using trans #}
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {% trans "Actions" %} {# Using trans #}
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for invoice in invoices %}
                <tr class="hover:bg-gray-100">
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                        <a href="{% url 'inventory:invoice_detail' invoice.pk %}"
                           class="text-blue-600 hover:text-blue-900">
                            {{ invoice.invoice_number }}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        {{ invoice.customer_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        {{ invoice.invoice_date|date:"Y-m-d" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ${{ invoice.total_amount|floatformat:2 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ${{ invoice.amount_paid|floatformat:2 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ${{ invoice.amount_remaining|floatformat:2 }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                        {# Django's get_FOO_display automatically uses i18n for model choices #}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if invoice.status == 'paid' %}bg-green-100 text-green-800
                            {% elif invoice.status == 'uncompleted' %}bg-yellow-100 text-yellow-800
                            {% elif invoice.status == 'sent' %}bg-blue-100 text-blue-800
                            {% elif invoice.status == 'draft' %}bg-gray-100 text-gray-800
                            {% elif invoice.status == 'cancelled' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">

                            {% trans invoice.get_status_display %} {# Translatable via model choices #}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2 rtl:space-x-reverse">
                        <a href="{% url 'admin:inventory_invoice_change' invoice.pk %}"
                           class="text-indigo-600 hover:text-indigo-900">
                            {% trans "Edit (Admin)" %} {# Using trans #}
                        </a>
                        <a href="{% url 'inventory:invoice_delete' invoice.pk %}"
                           class="text-red-600 hover:text-red-900">
                            {% trans "Delete" %} {# Using trans #}
                        </a>
                        <a href="{% url 'inventory:invoice_pdf' invoice.pk %}"
                           target="_blank"
                           class="text-blue-600 hover:text-blue-900">
                            {% trans "PDF" %} {# Using trans #}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p id="noInvoicesMsg" class="text-center text-gray-600 text-lg">
        {% trans "No invoices found." %} {# Using trans #}
    </p>
    {% endif %}
</div>

{# The JavaScript for client-side language toggle is removed here #}
{# The search filter can remain, as it operates on the displayed text regardless of language #}
<script>
// Search filter (operates on displayed text, so works with translated content)
document.getElementById('invoiceSearch').addEventListener('keyup', function() {
    const filter = this.value.toUpperCase();
    const rows = document.querySelectorAll('#invoiceTable tbody tr');
    rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (!cells.length) return;
        // Adjust indices if columns change order or count
        const invNum = cells[0].innerText.toUpperCase(); // Invoice Number
        const cust   = cells[1].innerText.toUpperCase(); // Customer Name
        const status = cells[6].innerText.toUpperCase(); // Status (now translated by Django)
        row.style.display = (invNum.indexOf(filter) > -1 ||
                             cust.indexOf(filter) > -1 ||
                             status.indexOf(filter) > -1) ? '' : 'none';
    });
});
</script>
{% endblock %}
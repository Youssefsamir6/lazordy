{% extends 'base.html' %}
{% load i18n %} {# Make sure this is present to use translation tags #}

{% load static %}

{% block title %}{% trans "Dashboard - Lazordy Inventory" %}{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Optional: Basic styling for chart containers if not using Tailwind's height/width classes directly on canvas */
        .chart-container {
            position: relative;
            height: 400px; /* Adjust height as needed */
            width: 100%;
        }
    </style>
{% endblock %}

{% block content %}
<div class="px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{% trans "Inventory Dashboard" %}</h1>
        <form method="get" action="">
            <input type="hidden" name="use_new_dashboard" value="1" />
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded">
                {% trans "Switch to New Dashboard" %}
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-1">{% trans "Total Products" %}</h2>
            <p class="text-5xl font-extrabold text-blue-600 dark:text-blue-400">{{ total_products }}</p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-1">{% trans "Total Estimated Value" %}</h2> {# ADDED trans tag #}
            <p class="text-5xl font-extrabold text-green-600 dark:text-green-400">{{ total_value|floatformat:2 }} EGP</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">{% trans "Based on current stock." %}</p> {# ADDED trans tag #}
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 text-center">
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-1">{% trans "Low Stock Items" %}</h2>
            <p class="text-5xl font-extrabold text-red-600 dark:text-red-400">{{ low_stock_items|length }}</p>
            {# Changed to blocktrans for the variable low_stock_threshold #}
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">{% blocktrans with threshold=low_stock_threshold %}Threshold: {{ threshold }} units{% endblocktrans %}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">{% trans "Monthly Sales Overview" %}</h3>
            <div class="chart-container">
                <canvas id="monthlySalesChart"></canvas>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">{% trans "Top Sold Products" %} ({{ product_movement_timeframe }})</h3>
            <div class="chart-container">
                <canvas id="topSellingProductsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow mb-10 overflow-hidden">
        <div class="bg-yellow-500 text-white px-6 py-4">
            <h3 class="text-xl font-semibold">{% blocktrans with threshold=low_stock_threshold %}Products with Low Stock (Below {{ threshold }} units){% endblocktrans %}</h3>
        </div>
        <div class="p-6">
            {% if low_stock_items %}
                <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for product in low_stock_items %}
                    <li class="py-3 flex justify-between items-center">
                        <a href="{% url 'inventory:product_detail' item_code=product.item_code %}"
                           class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium transition">
                            {{ product.name }} ({{ product.item_code }})
                        </a>
                        <span class="px-3 py-1 text-sm font-medium bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100 rounded-full">
                            {% blocktrans with quantity=product.quantity %}{{ quantity }} in stock{% endblocktrans %} {# ADDED blocktrans #}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-600 dark:text-gray-300">{% trans "No products are currently in low stock! ðŸŽ‰" %} </p>
            {% endif %}
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 mb-10">
        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">{% trans "Sales Trends & Analytics" %}</h3> {# ADDED trans tag #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <p class="text-gray-700 dark:text-gray-200">{% trans "Average Invoice Value:" %} <strong class="text-blue-600 dark:text-blue-400">{{ sales_overview.average_invoice_value|floatformat:2 }} EGP</strong></p> {# ADDED trans tag #}
            <p class="text-gray-700 dark:text-gray-200">{% trans "Total Invoices:" %} <strong class="text-blue-600 dark:text-blue-400">{{ sales_overview.total_invoices }}</strong></p> {# ADDED trans tag #}
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 mb-10" style="display: none;">
        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">{% trans "Raw Monthly Sales Data" %}</h3> {# ADDED trans tag #}
        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for month_data in monthly_sales %}
            <li class="py-3 flex justify-between items-center">
                <span>{{ month_data.month }}</span>
                <span class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-3 py-1 text-sm rounded-full">
                    {{ month_data.total_sales|floatformat:2 }} {% trans "EGP" %} {# Added trans tag for EGP if it's dynamic #}
                </span>
            </li>
            {% empty %}
            <li class="py-3 text-gray-600 dark:text-gray-300">{% trans "No monthly inventory data available." %}</li> {# ADDED trans tag #}
            {% endfor %}
        </ul>
    </div>
</div>

{# JSON Script tags to pass translated strings to JavaScript #}
{{ monthly_sales|json_script:"monthly-sales-data" }}
{{ product_movement|json_script:"top-selling-products-data" }}
{{ "Total Sales (EGP)"|json_script:"js-total-sales-egp" }} {# Translatable JS string #}
{{ "Month"|json_script:"js-month-label" }} {# Translatable JS string #}
{{ "Quantity Sold"|json_script:"js-quantity-sold" }} {# Translatable JS string #}
{{ "Product"|json_script:"js-product-label" }} {# Translatable JS string #}
{{ "Total Quantity Sold"|json_script:"js-total-quantity-sold" }} {# Translatable JS string #}
{{ "EGP"|json_script:"js-currency-symbol" }} {# Translatable JS string #}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Helper function to get translated string from json_script tags
        const gettext = (id) => {
            const element = document.getElementById(id);
            // Parse the content, or fallback to a simple string if element/content is missing
            return element ? JSON.parse(element.textContent) : id.replace('js-', '').replace(/-/g, ' '); // Basic fallback
        };

        // Get translated strings for charts
        const translatedTotalSalesEGP = gettext('js-total-sales-egp');
        const translatedMonthLabel = gettext('js-month-label');
        const translatedQuantitySold = gettext('js-quantity-sold');
        const translatedProductLabel = gettext('js-product-label');
        const translatedTotalQuantitySold = gettext('js-total-quantity-sold');
        const translatedEGP = gettext('js-currency-symbol');


        // --- Data for Monthly Sales Chart ---
        const monthlySalesDataElement = document.getElementById('monthly-sales-data');
        const monthlySalesData = monthlySalesDataElement ? JSON.parse(monthlySalesDataElement.textContent) : [];

        const monthlySalesLabels = monthlySalesData.map(item => item.month);
        const monthlySalesValues = monthlySalesData.map(item => item.total_sales);

        const ctxMonthly = document.getElementById('monthlySalesChart');
        if (ctxMonthly) { // Check if canvas element exists
            new Chart(ctxMonthly, {
                type: 'line',
                data: {
                    labels: monthlySalesLabels,
                    datasets: [{
                        label: translatedTotalSalesEGP, // Use translated string
                        data: monthlySalesValues,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.3, // Slightly curved line
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translatedTotalSalesEGP // Use translated string
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: translatedMonthLabel // Use translated string
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(2) + ' ' + translatedEGP; // Use translated EGP
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Data for Top Selling Products Chart ---
        // Get data from the script tag generated by json_script
        const topSellingProductsDataElement = document.getElementById('top-selling-products-data');
        const topSellingProductsData = topSellingProductsDataElement ? JSON.parse(topSellingProductsDataElement.textContent) : [];

        const productNames = topSellingProductsData.map(item => item.product__name);
        const quantitiesSold = topSellingProductsData.map(item => item.total_quantity_sold);

        const ctxTopSelling = document.getElementById('topSellingProductsChart');
        if (ctxTopSelling) { // Check if canvas element exists
            new Chart(ctxTopSelling, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: translatedQuantitySold, // Use translated string
                        data: quantitiesSold,
                        backgroundColor: [
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translatedTotalQuantitySold // Use translated string
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: translatedProductLabel // Use translated string
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw;
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}